<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>Twofish Crypter with DNS (CName) password retrieval, x64 shellcode decryption, and execution</title><meta name=description content="[Update: 7 April 2018]
I altered the Decrypter.c, not to get the raw password from the CNAME record from password.andrelima.info , but instead to get an hex …"><meta name=keywords content='blog,gokarna,hugo'><meta property="og:url" content="https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/"><meta property="og:type" content="website"><meta property="og:title" content="Twofish Crypter with DNS (CName) password retrieval, x64 shellcode decryption, and execution"><meta property="og:description" content="[Update: 7 April 2018]
I altered the Decrypter.c, not to get the raw password from the CNAME record from password.andrelima.info , but instead to get an hex …"><meta property="og:image" content="https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/images/09.png"><meta property="og:image:secure_url" content="https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/images/09.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Twofish Crypter with DNS (CName) password retrieval, x64 shellcode decryption, and execution"><meta name=twitter:description content="[Update: 7 April 2018]
I altered the Decrypter.c, not to get the raw password from the CNAME record from password.andrelima.info , but instead to get an hex …"><meta property="twitter:domain" content="https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/"><meta property="twitter:url" content="https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/"><meta name=twitter:image content="https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/images/09.png"><link rel=canonical href=https://0x4ndr3.github.io/posts/twofish-crypter-with-dns-cname-password-retrieval-x64-shellcode-decryption-and-execution/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.fdbfba1e074acb7e4abbf4c94eb19abb7702489c9689a27ee5e24a2bd481e4b7.js integrity="sha256-/b+6HgdKy35Ku/TJTrGau3cCSJyWiaJ+5eJKK9SB5Lc="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://0x4ndr3.github.io/><img src=https://0x4ndr3.github.io/main.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://0x4ndr3.github.io/>0x4ndr3</a></div><div class=nav-links><div class=nav-link><a href=https://0x4ndr3.github.io/posts/ aria-label><img class=svg-inject src=/icons/notepadplusplus.svg> Posts</a></div><div class=nav-link><a href=https://github.com/0x4ndr3 aria-label=github target=_blank><img class=svg-inject src=/icons/github.svg> Github</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://0x4ndr3.github.io/posts/><img class=svg-inject src=/icons/notepadplusplus.svg> Posts</a></li><li class=nav-item><a href=https://github.com/0x4ndr3 target=_blank><img class=svg-inject src=/icons/github.svg> Github</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Twofish Crypter with DNS (CName) password retrieval, x64 shellcode decryption, and execution</h1><small role=doc-subtitle></small><p class=post-date>February 2, 2018</p><ul class=post-tags></ul></div><div class=post-content><p><strong>[Update: 7 April 2018]</strong></p><p>I altered the Decrypter.c, not to get the raw password from the CNAME record from password.andrelima.info , but instead to get an hex encoded password from the same record in passwordhex.andrelima.info</p><p>This feature allows the Crypter to encrypt the shellcode with <strong>passwords containing special characters</strong>.</p><p>So, bear in mind some screenshots below might be outdated, but not the following:</p><p><img src=images/screen-shot-2018-04-07-at-8-47-24-pm.png alt="Screen Shot 2018-04-07 at 8.47.24 pm"></p><p>Crypter now presenting the password used secret_%”123 in hex to insert in the CNAME record</p><p><img src=images/screen-shot-2018-04-07-at-8-49-12-pm.png alt="Screen Shot 2018-04-07 at 8.49.12 pm"></p><p>Code added to Decrypter.c to decode the hex encoded password retrieved</p><p><img src=images/screen-shot-2018-04-07-at-9-05-45-pm.png alt="Screen Shot 2018-04-07 at 9.05.45 pm"></p><p>Successful hex encoded password retrieval, decoding, and decryption of shellcode</p><hr><p>A crypter is code that decrypts a previously encrypted payload, in this case a shellcode, and will then execute it. To encrypt it I chose one of the algorithms that went through the <a href=https://csrc.nist.gov/projects/cryptographic-standards-and-guidelines/archived-crypto-projects/aes-development target=_blank rel="nofollow noopener noreferrer"><span>final round
</span></a> of AES: <a href=https://www.schneier.com/academic/twofish/ target=_blank rel="nofollow noopener noreferrer"><span>Twofish
</span></a>. But to make this one unique, <strong>I decided not to request the password to decrypt the payload from the user (usually as the first parameter to the executable in the command line) but, instead, to get it from a DNS request (CNAME record)</strong> to the host “password.andrelima.info” which will return the password in the following format: &lt;password>.andrelima.info</p><p>But first things first. While I did quite a lot of rewriting, adapting, and debugging, the code I’ll be presenting is mostly derived from a <a href=https://www.schneier.com/code/twofish-cpy.zip target=_blank rel="nofollow noopener noreferrer">
<span>Twofish optimised C implementation
</span></a>by Drew Csillag, and a <a href=http://www.binarytides.com/dns-query-code-in-c-with-linux-sockets/ target=_blank rel="nofollow noopener noreferrer"><span>DNS query code in C
</span></a>by Silver Moon. The latter was chosen due to only using linux sockets, reducing any external library dependencies to a minimum.</p><h3 id=1-shellcode--payload>1. Shellcode / Payload</h3><p>The payload used in an execve stack implementation, which means that, after executing it, a command line prompt should present itself, as follows:</p><p><img src=images/01.png alt="Figure 1 – execve code"></p><p><img src=images/02.png alt="Figure 2 – execution"></p><p>The full explanation on this and other shellcodes I’ve developed can be found on one of my previous posts from which some, that I submitted into <a href="https://www.exploit-db.com/shellcodes?author=9244" target=_blank rel="nofollow noopener noreferrer"><span>Exploit DB
</span></a>, got accepted.</p><h3 id=2-crypter>2. Crypter</h3><p>As previously stated, the code base for the Twofish encryption was downloaded <a href=https://www.schneier.com/code/twofish-cpy.zip target=_blank rel="nofollow noopener noreferrer"><span>here
</span></a>, as it was the fastest implementation, in a reliable source, I could find. I then proceeded with adapting it to encrypt a shellcode and produce its output in hexadecimal format.</p><p><img src=images/03.png alt="Figure 3 – Crypter code to encrypt the shellcode"></p><p>The password, that the code will be using, shall be set as a command line parameter (argv[1]). The 128 bit encryption key is first set to all zeroes (cleanup for consistency certainty in the decryption process) and only then the given password is copied into the 16 bytes (128b) char array.</p><p>It is important to note that Twofish is a 128 bit block cipher. This means that, in the case of the shellcode, if its size is not an exact multiple of the block size, some padding will exist. In my first implementation I had the padding all set to zeroes. But in order to avoid any known-plaintext attacks, I later decided to generate a random stream of bytes. These random bytes will be of no consequence to the shellcode when decrypted, because after the last instruction (syscall – Figure 1, Line 18) nothing else will be executed. As stated by the execve documentation:</p><blockquote><p>execve() does not return on success, and the text, data, bss, and stack of the calling process are overwritten by that of the program loaded.</p></blockquote><p>This means that after the syscall instruction, we can have any random bytes and they’ll be of no consequence to the code execution. This is great, because I don’t need to worry about removing them at all.</p><p>One final note, regarding the compilation of the Crypter.c file, is that it requires giving GCC the “-O3” and “-fomit-frame-pointer” flags, as stated in the original code’s initial comments. The code uses some C optimisation techniques and it requires these flags to be able to compile it correctly. Another issue to be careful about, is the fact that the header file tables.h doesn’t exist originally in the <a href=https://www.schneier.com/code/twofish-cpy.zip target=_blank rel="nofollow noopener noreferrer"><span>Twofish download
</span></a>. It is actually generated by the provided python script as follows:</p><blockquote><p>python makeCtables.py > tables.h</p><p>gcc -O3 -fomit-frame-pointer Crypter.c tables.h -o Crypter</p></blockquote><p>After executing the crypter (which will produce a different output – actually just the last 128 bit block – every time it’s executed, due to the random byte stream generated to pad the original shellcode):</p><p><img src=images/04.png alt="Figure 4 – Encrypted shellcode generated with password “secret123”"></p><p>The password to decrypt the shellcode is set in the command line to the crypter: <strong>secret123</strong></p><h3 id=3-the-dns-setup>3. The DNS setup</h3><p>The DNS setup is how I decided to store the password for decrypting the shellcode. The point is to have it as a CName DNS record associated with the host password.andrelima.info :</p><p><img src=images/05.png alt="Figure 5 – Domain name service provider CNAME configuration"></p><p>This can be easily verified with the <em>dig</em> tool (<em>dig password.andrelima.info cname +short</em>):</p><p><img src=images/06.png alt="Figure 6 – CName retrieval using dig command line tools"></p><p>Of course one could set a local DNS server and test this functionality (e.g. bind9), but I already owned the domain “andrelima.info” and all I had to do was go in the DNS management page and add a record (Figure 5), which I’ll leave as is, for anyone who wishes to quickly test the <a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_07 target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>.</p><h3 id=4-decrypter>4. Decrypter</h3><p>Now that the password is set, its retrieval is exactly the first thing the Decrypter will need to do:</p><p><img src=images/07.png alt="Figure 7 – DNS CName password retrieval"></p><p>The <em>ngethostbyname</em> will basically get the DNS record type specified as the second parameter (CName), which is associated with the host in the first parameter. It then proceeds to extracting the password from the retrieved string &lt;password>.andrelima.info.</p><p>An <strong>improvement</strong> to this code will be to encode the password to make it possible to use any special characters in it. Hex format would be great, as it would be acceptable in the URL format to have something like <em>03f78b…a18d.andrelima.info</em>.</p><p>So after getting the password, the code moves on to decrypting the encrypted shellcode shown in Figure 4:</p><p><img src=images/081.png alt="Figure 8 – Code decrypting the encrypted shellcode from Fig 4"></p><p>To compile this, we run:</p><blockquote><p>gcc <strong>-O3 -fomit-frame-pointer</strong> <strong>-fno-stack-protector -z execstack</strong> Decrypter.c tables.h -o Decrypter</p></blockquote><p>This command now has the flags <em>-fno-stack-protector -z execstack</em>  to allow for the execution of code in the stack – our decrypted shellcode.</p><p>And it then runs smoothly as expected (with some unnecessary but convenient debugging information):</p><p><img src=images/09.png alt="Figure 9 – running the Decrypter"></p><p>You can find <a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_07 target=_blank rel="nofollow noopener noreferrer">
<span>all the files on my gitlab account
</span></a>.</p><p>Thanks to <a href=https://twitter.com/securitytube target=_blank rel="nofollow noopener noreferrer">
<span>Vivek Ramachandran
</span></a> and the <a href=http://www.pentesteracademy.com/topics target=_blank rel="nofollow noopener noreferrer">
<span>Pentester Academy
</span></a> team, as I have enjoyed every second of this course since I’ve learned so many interesting things. All this, inspired me to learn even more and push the posts to always do a little bit more as well. Appreciate your work!</p><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><ul><li>Current URL: <a href=https://my.ine.com/CyberSecurity/courses/42f93b0f/x86_64-assembly-language-and-shellcoding-on-linux target=_blank rel="nofollow noopener noreferrer"><span>https://my.ine.com/CyberSecurity/courses/42f93b0f/x86_64-assembly-language-and-shellcoding-on-linux</span></a></li><li>Original URL (does not work anymore): <a href=http://www.securitytube-training.com/online-courses/x8664-assembly-and-shellcoding-on-linux/index.html target=_blank rel="nofollow noopener noreferrer"><span>http://www.securitytube-training.com/online-courses/x8664-assembly-and-shellcoding-on-linux/index.html</span></a></li></ul><p><strong>Student ID: PA-2109</strong></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2018 Andre Lima</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>