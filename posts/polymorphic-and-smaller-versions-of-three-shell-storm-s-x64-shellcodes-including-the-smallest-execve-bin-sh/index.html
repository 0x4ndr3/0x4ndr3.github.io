<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>Polymorphic and smaller versions of three shell-storm’s x64 shellcodes, including the smallest execve /bin/sh</title><meta name=description content="[Update 13 Jan 2018]
ExploitDB has published the 3 shellcodeswritten in this blog post.
Linux/x86-64 – Execute /bin/shShellcode (24 bytes)
Linux/x86-64 – Add …"><meta name=keywords content='blog,gokarna,hugo'><meta property="og:url" content="https://0x4ndr3.github.io/posts/polymorphic-and-smaller-versions-of-three-shell-storm-s-x64-shellcodes-including-the-smallest-execve-bin-sh/"><meta property="og:type" content="website"><meta property="og:title" content="Polymorphic and smaller versions of three shell-storm’s x64 shellcodes, including the smallest execve /bin/sh"><meta property="og:description" content="[Update 13 Jan 2018]
ExploitDB has published the 3 shellcodeswritten in this blog post.
Linux/x86-64 – Execute /bin/shShellcode (24 bytes)
Linux/x86-64 – Add …"><meta property="og:image" content="https://0x4ndr3.github.io/pic.png"><meta property="og:image:secure_url" content="https://0x4ndr3.github.io/pic.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Polymorphic and smaller versions of three shell-storm’s x64 shellcodes, including the smallest execve /bin/sh"><meta name=twitter:description content="[Update 13 Jan 2018]
ExploitDB has published the 3 shellcodeswritten in this blog post.
Linux/x86-64 – Execute /bin/shShellcode (24 bytes)
Linux/x86-64 – Add …"><meta property="twitter:domain" content="https://0x4ndr3.github.io/posts/polymorphic-and-smaller-versions-of-three-shell-storm-s-x64-shellcodes-including-the-smallest-execve-bin-sh/"><meta property="twitter:url" content="https://0x4ndr3.github.io/posts/polymorphic-and-smaller-versions-of-three-shell-storm-s-x64-shellcodes-including-the-smallest-execve-bin-sh/"><meta name=twitter:image content="https://0x4ndr3.github.io/pic.png"><link rel=canonical href=https://0x4ndr3.github.io/posts/polymorphic-and-smaller-versions-of-three-shell-storm-s-x64-shellcodes-including-the-smallest-execve-bin-sh/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.fdbfba1e074acb7e4abbf4c94eb19abb7702489c9689a27ee5e24a2bd481e4b7.js integrity="sha256-/b+6HgdKy35Ku/TJTrGau3cCSJyWiaJ+5eJKK9SB5Lc="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://0x4ndr3.github.io/><img src=https://0x4ndr3.github.io/pic.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://0x4ndr3.github.io/>0x4ndr3</a></div><div class=nav-links><div class=nav-link><a href=https://0x4ndr3.github.io/posts/ aria-label><img class=svg-inject src=/icons/notepadplusplus.svg> Posts</a></div><div class=nav-link><a href=https://github.com/0x4ndr3 aria-label=github target=_blank><img class=svg-inject src=/icons/github.svg> Github</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://0x4ndr3.github.io/posts/><img class=svg-inject src=/icons/notepadplusplus.svg> Posts</a></li><li class=nav-item><a href=https://github.com/0x4ndr3 target=_blank><img class=svg-inject src=/icons/github.svg> Github</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Polymorphic and smaller versions of three shell-storm’s x64 shellcodes, including the smallest execve /bin/sh</h1><small role=doc-subtitle></small><p class=post-date>January 12, 2018</p><ul class=post-tags></ul></div><div class=post-content><p><strong>[Update 13 Jan 2018]</strong></p><p>ExploitDB has published the <a href="https://www.exploit-db.com/shellcodes?author=9244" target=_blank rel="nofollow noopener noreferrer"><span>3 shellcodes
</span></a>written in this blog post.</p><p>Linux/x86-64 – <a href=https://www.exploit-db.com/exploits/43550/ target=_blank rel="nofollow noopener noreferrer"><span>Execute /bin/sh
</span></a>Shellcode (24 bytes)<br>Linux/x86-64 – <a href=https://www.exploit-db.com/exploits/43552/ target=_blank rel="nofollow noopener noreferrer"><span>Add Map (127.1.1.1 google.lk) In /etc/hosts
</span></a>Shellcode (96 bytes)<br>Linux/x86-64 – <a href=https://www.exploit-db.com/exploits/43553/ target=_blank rel="nofollow noopener noreferrer"><span>execve(“/sbin/iptables”, [“/sbin/iptables”, “-F”], NULL)
</span></a>Shellcode (43 bytes)</p><hr><p>Looking at the smallest x64 shellcodes (section Linux / Intel x86-64) in <a href=http://shell-storm.org/shellcode/ target=_blank rel="nofollow noopener noreferrer"><span>shell-storm
</span></a>‘s website, we find the following:</p><ul><li>Linux/x86-64 – reboot(POWER_OFF) – 19 bytes by zbt</li><li>Linux/x86-64 – Execute /bin/sh – 27 bytes by Dad`</li><li>Linux/x86-64 – execve(/bin/sh); – 30 bytes by zbt</li><li>Linux/x86-64 – execve(/bin/sh, [/bin/sh], NULL) – 33 bytes by hophet</li><li>Linux/x86-64 – sethostname() & killall – 33 bytes by zbt</li></ul><p>Due to similar functionalities of some, which makes it pointless to alter their bigger versions, I reduced the list to:</p><ul><li>Linux/x86-64 – reboot(POWER_OFF) – 19 bytes by zbt</li><li><a href=http://shell-storm.org/shellcode/files/shellcode-806.php target=_blank rel="nofollow noopener noreferrer"><span>Linux/x86-64 – Execute /bin/sh – 27 bytes by Dad`</span></a></li><li>Linux/x86-64 – sethostname() & killall – 33 bytes by zbt</li></ul><p>Because I didn’t want a painful debug/test process (as in a reboot after every shellcode execution), I decided to only keep the <em><a href=http://shell-storm.org/shellcode/files/shellcode-806.php target=_blank rel="nofollow noopener noreferrer">
<span>Linux/x86-64 – Execute /bin/sh – 27 bytes
</span></a></em>, while choosing other more interesting shellcodes:</p><ul><li><a href=http://shell-storm.org/shellcode/files/shellcode-896.php target=_blank rel="nofollow noopener noreferrer"><span>Linux/x86-64 – Add map in /etc/hosts file – 110 bytes by Osanda Malith Jayathissa</span></a></li><li><a href=http://shell-storm.org/shellcode/files/shellcode-683.php target=_blank rel="nofollow noopener noreferrer"><span>Linux/x86-64 – execve(/sbin/iptables, [/sbin/iptables, -F], NULL) – 49 bytes by 10n1z3d</span></a></li></ul><p>There were a couple other shellcodes I noticed I not only had altered in the past but also shortened. The <a href=http://shell-storm.org/shellcode/files/shellcode-890.php target=_blank rel="nofollow noopener noreferrer"><span>password protected reverse shell
</span></a>for example, I’d done a <a href=https://0x4ndr3.github.io/posts/x86_64-reverse-tcp-bind-shell-with-basic-authentication-on-linux-systems/ target=_blank rel="nofollow noopener noreferrer"><span>blog post
</span></a>on it already.</p><p>One note before starting to execute third party shellcode: only do this after fully understanding the code you’re compiling/executing, otherwise do it on a disposable VM/snapshot.</p><h3 id=the-original-execute-binsh--27-bytes-by-dad>The original Execute /bin/sh – 27 bytes by Dad`</h3><p>The original <a href=http://shell-storm.org/shellcode/files/shellcode-806.php target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>:</p><p><a href=http://shell-storm.org/shellcode/files/shellcode-806.php target=_blank rel="nofollow noopener noreferrer"><span><img src=images/fig11.png alt="Figure 1 – original smallest execve on shell-storm (Linux x86_64)"></span></a></p><p>To call execve, one needs to invoke it and send the following parameters:</p><p><img src=images/fig2.png alt="Figure 2 – execve(…) parameters at “$ man 2 execve”"></p><p>I’ve already explained the x64 Linux calling convention on my <a href=https://0x4ndr3.github.io/posts/x86_64-tcp-bind-shellcode-with-basic-authentication-on-linux-systems/ target=_blank rel="nofollow noopener noreferrer"><span>first shellcode post
</span></a>, so suffice to say that:</p><ul><li>rax = 59</li><li>rdi = “/bin/sh”</li><li>rsi = [“/bin/sh”, NULL byte]</li><li>rdx = 0</li></ul><p>Notice that the 3rd parameter in the function call (envp) – stored in RDX register – can actually be ignored as per execve manual’s page ($man 2 execve):</p><blockquote><p>Note, however, that the use of a third argument to the main function is not specified in POSIX.1; according to POSIX.1, the environment should be accessed via the external variable environ(7).</p></blockquote><p>So a null byte is placed there (set to zero) instead of actually worrying about setting it to the environment variables address in memory.</p><p>One of the problems with setting a register with the value “/bin/sh” is that this string is exactly 7 bytes long. This means that, when the code is compiled into binary it will fill that missing byte with an understandable 0x00. This breaks one of the rules of shellcode development: no null bytes.</p><p>But there are a few tricks to overcome this problem. One of them is to use “//bin/sh” or “/bin//sh” which are equivalent to “/bin/sh”. Another trick, and the one used in the original code (Figure 1) is to set the register with the negative equivalent of the value it actually wants. And then negate it with the “neg” operator.</p><p>Note that this is not the same operation as the “not”. As the negative equivalent (neg) of 0 is still 0, while the bit flip (not) would be 0xffffffffffffffff.</p><p>You can see the negation occurring here:</p><p><img src=images/fig4.png alt="Figure 3"></p><p>The value in RBX after the negation is 0x68732f6e69622f which is “/bin/sh”:</p><p><img src=images/fig5.png alt="Figure 4"></p><h3 id=the-altered-and-shorter-execve--24-bytes>The altered (and shorter) execve – 24 bytes</h3><p>The <a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_06/execve target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>:</p><p><a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_06/execve target=_blank rel="nofollow noopener noreferrer"><span><img src=images/fig51.png alt="Figure 5 – altered and shorter execve"></span></a></p><p><img src=images/fig6.png alt="Figure 6 – shellcode executing"></p><p>Changes:</p><ul><li>The original code uses RAX to store a zero value (Line 4 in Figure 1), which it ends up not using for the intended purposes (Line 12 in Figure 1), but instead using RDX. So basically the code is setting RAX with zero, and then setting it to 59 (0x3b). These two steps (adding up to 4 bytes in opcode) can be summarised into lines 4 and 5 in Figure 5 (3 bytes in opcode).</li><li>The original code also uses the “neg” operator, which consumes 3 bytes. The fact that Figure 5’s code is using a different technique (to avoid the null byte in the shellcode), makes it so we don’t have to use the “neg” operator, but instead a “push rdx” to have that “//bin/sh” string null terminated as required by the specification in execve man page. This push is only one byte long, saving another 2 bytes from the original code.</li></ul><h3 id=the-original-linuxx86-64--add-map-in-etchosts-file--110-bytes>The original Linux/x86-64 – Add map in /etc/hosts file – 110 bytes</h3><p>The original <a href=http://shell-storm.org/shellcode/files/shellcode-896.php target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>:</p><p><a href=http://shell-storm.org/shellcode/files/shellcode-896.php target=_blank rel="nofollow noopener noreferrer"><span><img src=images/fig7.png alt="Figure 7 – original shellcode that adds ‘127.1.1.1 google.lk’ to the end of /etc/hosts file"></span></a></p><h3 id=the-altered-and-shorter-add-map-in-etchosts-with-96-bytes>The altered (and shorter) Add map in /etc/hosts with 96 bytes</h3><p>The <a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_06/add_map target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>:</p><p><a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_06/add_map target=_blank rel="nofollow noopener noreferrer"><span><img src=images/fig8.png alt="Figure 8 – altered and shorter add map shellcode"></span></a></p><p>State of /etc/hosts file before executing the shellcode:</p><p><img src=images/fig9.png alt="Figure 9 – prior to executing the shellcode"></p><p>And after:</p><p><img src=images/fig10.png alt="Figure 10 – after executing the shellcode"></p><h3 id=the-original-execvesbiniptables-sbiniptables--f-null--49-bytes>The original execve(/sbin/iptables, [/sbin/iptables, -F], NULL) – 49 bytes</h3><p>The original <a href=http://shell-storm.org/shellcode/files/shellcode-683.php target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>:</p><p><a href=http://shell-storm.org/shellcode/files/shellcode-683.php target=_blank rel="nofollow noopener noreferrer"><span><img src=images/fig111.png alt="Figure 11 – original shellcode that flushes the iptables firewall"></span></a></p><h3 id=the-altered-and-shorter-execve-iptables--f-with-43-bytes>The altered (and shorter) execve (iptables -F) with 43 bytes</h3><p>The <a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_06/iptables_flush target=_blank rel="nofollow noopener noreferrer"><span>code
</span></a>:</p><p><a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments/tree/master/Assignment_06/iptables_flush target=_blank rel="nofollow noopener noreferrer"><span><img src=images/fig12.png alt="Figure 12 – altered and shorter iptables flush shellcode"></span></a></p><p>Iptables list before and after the shellcode execution:</p><p><img src=images/fig13.png alt="Figure 13 – prior to shellcode execution, the firewall was blocking some traffic"></p><p><img src=images/fig14.png alt="Figure 14 – after execution, no more blocking rules exist"></p><p>You can find <a href=https://gitlab.com/0x4ndr3/SLAE64_Assignments target=_blank rel="nofollow noopener noreferrer">
<span>all the files on my gitlab account
</span></a>.</p><p>Thanks to <a href=https://twitter.com/securitytube target=_blank rel="nofollow noopener noreferrer">
<span>Vivek Ramachandran
</span></a> and the <a href=http://www.pentesteracademy.com/topics target=_blank rel="nofollow noopener noreferrer">
<span>Pentester Academy
</span></a> team, as I have enjoyed every second of this course since I’ve learned so many interesting things, and all this inspired me to learn even more. Appreciate your work!</p><hr><p>This blog post has been created for completing the requirements of the SecurityTube Linux Assembly Expert certification:</p><ul><li>Current URL: <a href=https://my.ine.com/CyberSecurity/courses/42f93b0f/x86_64-assembly-language-and-shellcoding-on-linux target=_blank rel="nofollow noopener noreferrer"><span>https://my.ine.com/CyberSecurity/courses/42f93b0f/x86_64-assembly-language-and-shellcoding-on-linux</span></a></li><li>Original URL (does not work anymore): <a href=http://www.securitytube-training.com/online-courses/x8664-assembly-and-shellcoding-on-linux/index.html target=_blank rel="nofollow noopener noreferrer"><span>http://www.securitytube-training.com/online-courses/x8664-assembly-and-shellcoding-on-linux/index.html</span></a></li></ul><p><strong>Student ID: PA-2109</strong></p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2018 Andre Lima</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>